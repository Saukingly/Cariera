{% extends "partials/base.html" %}
{% load static %}

{% block title %}Career Constellation{% endblock title %}

{% block extra_css %}
<style>
    :root {
        --star-transition-speed: 0.3s;
    }

    @keyframes pulse-glow {
        0%, 100% { box-shadow: 0 0 25px rgba(var(--vz-primary-rgb), 0.7); }
        50% { box-shadow: 0 0 40px rgba(var(--vz-primary-rgb), 1); }
    }

    @keyframes star-twinkle {
        0% { transform: scale(1); opacity: 0.8; }
        50% { transform: scale(1.1); opacity: 1; }
        100% { transform: scale(1); opacity: 0.8; }
    }

    /* More prominent glitter-fall for top match */
    @keyframes glitter-fall {
        0% { transform: translateY(-15px) scale(1); opacity: 1; }
        100% { transform: translateY(120px) scale(0.5) rotate(360deg); opacity: 0; }
    }

    @keyframes sparkle-twinkle {
        0%, 100% { transform: scale(0) rotate(0deg); opacity: 0; }
        50% { transform: scale(1.2) rotate(180deg); opacity: 1; }
    }

    @keyframes milky-way-drift {
        0% { transform: translateX(-100px) rotate(-15deg); opacity: 0.3; }
        50% { transform: translateX(0) rotate(-12deg); opacity: 0.6; }
        100% { transform: translateX(100px) rotate(-10deg); opacity: 0.3; }
    }

    @keyframes distant-star-twinkle {
        0% { opacity: 0.2; }
        50% { opacity: 0.8; }
        100% { opacity: 0.2; }
    }

    .constellation-container {
        position: relative;
        width: 100%;
        height: 500px; /* Increased height for more space */
        background-image:
            radial-gradient(ellipse at 20% 30%, rgba(30, 60, 120, 0.4) 0%, transparent 50%),
            radial-gradient(ellipse at 80% 70%, rgba(60, 30, 120, 0.3) 0%, transparent 50%),
            radial-gradient(ellipse at center, #1c274c 0%, #060e22 100%);
        border-radius: .625rem;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: inset 0 0 100px rgba(0,0,0,0.5);
        margin: 0 auto;
        max-width: 1200px;
        user-select: none; /* Prevent text selection while dragging */
    }

    /* Milky Way and background stars (unchanged) */
    .constellation-container::before {
        content: ''; position: absolute; top: 20%; left: -10%; width: 120%; height: 40%;
        background: linear-gradient(-15deg, transparent 20%, rgba(100, 150, 255, 0.1) 30%, rgba(200, 220, 255, 0.15) 45%, rgba(255, 255, 255, 0.08) 50%, rgba(200, 220, 255, 0.15) 55%, rgba(100, 150, 255, 0.1) 70%, transparent 80%);
        animation: milky-way-drift 20s infinite ease-in-out; pointer-events: none; z-index: 1;
    }
    .constellation-container::after {
        content: ''; position: absolute; width: 1px; height: 1px; border-radius: 50%;
        box-shadow: 50px 100px #FFF, 150px 200px #FFF, 250px 50px #FFF, 350px 150px #FFF, 450px 300px #FFF, 80px 250px #FFF, 180px 80px #FFF, 280px 220px #FFF, 380px 40px #FFF, 480px 180px #FFF, 120px 320px #FFF, 220px 160px #FFF, 320px 80px #FFF, 420px 260px #FFF, 520px 120px #FFF, 30px 180px rgba(255,255,255,0.6), 130px 280px rgba(255,255,255,0.7), 230px 120px rgba(255,255,255,0.5), 330px 200px rgba(255,255,255,0.6), 430px 60px rgba(255,255,255,0.8), 530px 240px rgba(255,255,255,0.4), 60px 60px rgba(100,150,255,0.6), 160px 360px rgba(150,100,255,0.5), 260px 180px rgba(255,150,100,0.4), 360px 300px rgba(100,255,150,0.3), 460px 120px rgba(255,100,150,0.5), 560px 280px rgba(150,255,100,0.4), 90px 140px 1px rgba(255,255,255,0.8), 190px 240px 1px rgba(255,255,255,0.6), 290px 340px 1px rgba(255,255,255,0.7), 390px 80px 1px rgba(255,255,255,0.5), 490px 180px 1px rgba(255,255,255,0.9), 590px 20px 1px rgba(255,255,255,0.4), 70px 70px rgba(255,255,255,0.3), 170px 170px rgba(255,255,255,0.4), 270px 270px rgba(255,255,255,0.5), 370px 70px rgba(255,255,255,0.6), 470px 170px rgba(255,255,255,0.3), 570px 270px rgba(255,255,255,0.7);
        animation: distant-star-twinkle 8s infinite alternate; pointer-events: none; z-index: 1;
    }

    .user-center {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 120px; height: 120px; background-color: rgba(var(--vz-primary-rgb), 0.8);
        color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-direction: column;
        font-weight: 600; z-index: 10; border: 4px solid rgba(255, 255, 255, 0.5);
        animation: pulse-glow 3s infinite ease-in-out; text-align: center;
    }
    .user-center .user-icon { font-size: 2.5rem; line-height: 1; }
    .user-center .user-text { font-size: 1rem; margin-top: 5px; }

    .career-star {
        position: absolute; display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #fff;
        z-index: 5; cursor: grab; width: 110px; height: 140px;
        /* No transition on left/top during drag, but will be added for snap-back */
    }
    .career-star.is-dragging { cursor: grabbing; z-index: 100; }
    .career-star.is-returning { transition: transform var(--star-transition-speed) ease-out, opacity var(--star-transition-speed) ease; }

    /* Connection line (unchanged) */
    .career-star::before {
        content: ''; position: absolute; top: 40px; left: 55px; height: 2px;
        width: var(--distance, 0px); background-image: linear-gradient(to right, rgba(13, 202, 240, 0.7), rgba(13, 202, 240, 0));
        transform-origin: left center; transform: rotate(var(--angle, 0deg)); opacity: var(--opacity, 0.5);
        transition: opacity 0.3s ease, width 0.3s ease; pointer-events: none; z-index: -1;
    }

    .career-star .star-visual {
        width: 80px; height: 80px; background-color: rgba(var(--vz-info-rgb), 0.2); border-radius: 50%;
        border: 2px solid rgba(13, 202, 240, 0.7); display: flex; align-items: center; justify-content: center;
        transition: background-color 0.3s ease, box-shadow 0.3s ease;
        box-shadow: 0 0 var(--glow, 15px) rgba(13, 202, 240, var(--glow-intensity, 0.3));
        position: relative; animation: star-twinkle 4s infinite alternate; overflow: visible;
    }

    /* Base Sparkle/Glitter effects */
    .career-star .star-visual::after, .career-star .star-visual::before {
        content: ''; position: absolute; pointer-events: none;
    }
    .career-star .star-visual::before { /* Sparkle */
        content: 'âœ¦'; color: #ffffff; font-size: 8px; text-shadow: 0 0 4px #fff, 0 0 8px #fff;
        animation: sparkle-twinkle 3s infinite ease-in-out; opacity: 0; left: 75%; top: 15%;
    }
    .career-star .star-name {
        margin-top: 12px; font-weight: 500; font-size: 13px; text-shadow: 1px 1px 3px #000;
        text-align: center; padding: 4px 6px; background-color: rgba(0,0,0,0.7); border-radius: 8px;
        width: 110px; white-space: normal; overflow: visible; text-overflow: clip; line-height: 1.3;
    }

    /* --- SPECIAL STYLES FOR THE TOP MATCH --- */
    .career-star.is-top-match .star-visual {
        /* More prominent, pulsing glow */
        --glow: calc(var(--base-glow) * 2);
        --glow-intensity: calc(var(--base-glow-intensity) * 1.5);
        animation: star-twinkle 2s infinite alternate, pulse-glow 2.5s infinite ease-in-out;
        border-color: rgba(255, 255, 255, 0.8);
    }
    .career-star.is-top-match .star-visual::after { /* Glitter Fall */
        width: 4px; height: 4px; background: linear-gradient(45deg, #ffffff, #f0f8ff, #e6f3ff);
        border-radius: 50%; box-shadow: 0 0 4px #fff, 0 0 8px #fff, 0 0 12px rgba(255, 255, 255, 0.8);
        animation: glitter-fall 2.5s infinite ease-out; opacity: 0; left: 50%; top: -5px;
        animation-delay: calc(var(--animation-order) * 0.2s);
    }
    .career-star.is-top-match .star-visual::before { /* Brighter Sparkle */
         animation-duration: 1.5s;
         text-shadow: 0 0 6px #fff, 0 0 12px #fff;
    }

    /* Dynamic effects based on match percentage (Slightly adjusted) */
    {% for career in careers %}
        .career-star:nth-of-type({{ forloop.counter }}) {
            --opacity: calc({{ career.match }} / 100 * 0.7 + 0.3);
            --animation-order: {{ forloop.counter0 }};
        }
        .career-star:nth-of-type({{ forloop.counter }}) .star-visual {
            --base-glow: calc({{ career.match }} / 100 * 25px + 10px);
            --base-glow-intensity: calc({{ career.match }} / 100 * 0.6 + 0.2);
            --glow: var(--base-glow);
            --glow-intensity: var(--base-glow-intensity);
        }
        .career-star:nth-of-type({{ forloop.counter }}) .star-visual::before { /* Sparkle */
            animation-delay: calc(var(--animation-order) * 0.4s);
            opacity: calc({{ career.match }} / 100 * 0.8 + 0.1);
        }
    {% endfor %}

    /* Mobile responsive adjustments (unchanged) */
    @media (max-width: 768px) {
        .constellation-container { height: 550px; }
        .career-star { width: 80px; height: 110px; }
        .career-star .star-visual { width: 60px; height: 60px; }
        .career-star::before { top: 30px; left: 40px; }
        .career-star .star-name { font-size: 11px; width: 80px; padding: 2px 4px; margin-top: 8px; }
        .user-center { width: 100px; height: 100px; }
    }
</style>
{% endblock extra_css %}

{% block content %}
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            <!-- page title -->
            <div class="row">
                <div class="col-12">
                    <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                        <h4 class="mb-sm-0">Career Constellation</h4>
                        <div class="page-title-right"><ol class="breadcrumb m-0"><li class="breadcrumb-item"><a href="{% url 'apps:journeys.list' %}">My Journeys</a></li><li class="breadcrumb-item active">Explore</li></ol></div>
                    </div>
                </div>
            </div>
            <!-- end page title -->

            <div class="row">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-header"><h5 class="card-title mb-0">Explore Your Career Matches</h5></div>
                        <div class="card-body">

                            {% if careers %}
                                <p class="text-muted mb-4">Your universe of possibilities. Based on your conversations, we've identified career paths that align with you. Brighter, closer stars are stronger matches. Click and drag to explore.</p>

                                <div class="constellation-container">
                                    <div class="user-center">
                                        <i class="ri-user-star-line user-icon"></i>
                                        <span class="user-text">You</span>
                                    </div>

                                    {% for career in careers %}
                                    <a href="#" class="career-star" data-match="{{ career.match }}">
                                        <div class="star-visual">
                                            <h5 class="text-white mb-0">{{ career.match }}%</h5>
                                        </div>
                                        <span class="star-name">{{ career.name }}</span>
                                    </a>
                                    {% endfor %}
                                </div>

                            {% else %}
                                <!-- Fallback content (unchanged) -->
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% block footer %}{% include "partials/footer.html" %}{% endblock footer %}
</div>

<!-- ============================================================== -->
<!-- START DYNAMIC & PHYSICS-BASED LAYOUT SCRIPT -->
<!-- ============================================================== -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    const container = document.querySelector('.constellation-container');
    if (!container) return;

    const stars = Array.from(container.querySelectorAll('.career-star'));
    const userCenter = container.querySelector('.user-center');
    let animationFrameId = null;

    // --- 1. INITIAL LAYOUT CALCULATION ---
    function layoutConstellation() {
        const starCount = stars.length;
        if (starCount === 0) return;

        // Find the top match to give it special properties
        let topMatchStar = stars.reduce((prev, current) => (parseFloat(prev.dataset.match) > parseFloat(current.dataset.match)) ? prev : current);
        stars.forEach(s => s.classList.remove('is-top-match'));
        topMatchStar.classList.add('is-top-match');

        const containerWidth = container.offsetWidth;
        const containerHeight = container.offsetHeight;
        const centerX = containerWidth / 2;
        const centerY = containerHeight / 2;

        // Define the min/max distance from the center
        const maxRadiusX = (containerWidth / 2) - 80;
        const maxRadiusY = (containerHeight / 2) - 80;
        const minRadius = 120; // Closest a 100% match can be
        const centerNodeRadius = userCenter.offsetWidth / 2;

        stars.forEach((star, index) => {
            const matchPercentage = parseFloat(star.dataset.match) / 100.0;

            // Calculate radius based on match percentage. Higher % = smaller radius (closer).
            const radiusFactor = 1 - matchPercentage;
            const radiusX = minRadius + (maxRadiusX - minRadius) * radiusFactor;
            const radiusY = minRadius + (maxRadiusY - minRadius) * radiusFactor;

            const angle = (index / starCount) * 2 * Math.PI;
            const starWidth = star.offsetWidth;
            const starHeight = star.offsetHeight;

            const homeX = centerX + radiusX * Math.cos(angle) - (starWidth / 2);
            const homeY = centerY + radiusY * Math.sin(angle) - (starHeight / 2);

            // Store the "home" position for the physics animation
            star.dataset.homeX = homeX;
            star.dataset.homeY = homeY;

            // Set initial position
            star.style.left = `${homeX}px`;
            star.style.top = `${homeY}px`;

            // --- Calculate Connection Line ---
            const starCenterX = homeX + (starWidth / 2);
            const starCenterY = homeY + (star.querySelector('.star-visual').offsetHeight / 2);
            const deltaX = centerX - starCenterX;
            const deltaY = centerY - starCenterY;
            const distance = Math.hypot(deltaX, deltaY) - centerNodeRadius;
            const lineAngleDeg = Math.atan2(deltaY, deltaX) * (180 / Math.PI);

            star.style.setProperty('--distance', `${distance}px`);
            star.style.setProperty('--angle', `${lineAngleDeg}deg`);

            // Initialize physics properties
            star.physics = {
                x: homeX, y: homeY,
                vx: 0, vy: 0,
                isAnimating: false
            };
        });
    }

    // --- 2. PHYSICS-BASED DRAGGING AND RETURN ANIMATION ---
    stars.forEach(star => {
        let isDragging = false;
        let startX, startY, dragStartX, dragStartY;

        star.addEventListener('mousedown', (e) => {
            e.preventDefault();
            isDragging = true;
            star.classList.add('is-dragging');
            star.physics.isAnimating = false; // Stop any return animation
            cancelAnimationFrame(animationFrameId);

            startX = e.clientX;
            startY = e.clientY;
            dragStartX = star.offsetLeft;
            dragStartY = star.offsetTop;

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });

        function onMouseMove(e) {
            if (!isDragging) return;
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            star.style.left = `${dragStartX + dx}px`;
            star.style.top = `${dragStartY + dy}px`;
            star.physics.x = dragStartX + dx;
            star.physics.y = dragStartY + dy;
        }

        function onMouseUp() {
            if (!isDragging) return;
            isDragging = false;
            star.classList.remove('is-dragging');
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);

            // Start the spring animation to return home
            star.physics.isAnimating = true;
            startReturnAnimation();
        }
    });

    function startReturnAnimation() {
        // Constants for the spring physics
        const stiffness = 0.05; // How strong the spring is
        const damping = 0.75;  // How quickly it stops bouncing
        const precision = 0.1; // How close to get before stopping

        function animate() {
            let stillAnimating = false;
            stars.forEach(star => {
                if (!star.physics.isAnimating) return;

                const homeX = parseFloat(star.dataset.homeX);
                const homeY = parseFloat(star.dataset.homeY);

                // Calculate spring force (Hooke's Law)
                const forceX = (homeX - star.physics.x) * stiffness;
                const forceY = (homeY - star.physics.y) * stiffness;

                // Update velocity (acceleration) and apply damping
                star.physics.vx = (star.physics.vx + forceX) * damping;
                star.physics.vy = (star.physics.vy + forceY) * damping;

                // Update position
                star.physics.x += star.physics.vx;
                star.physics.y += star.physics.vy;

                // Stop animation if it's close enough and slow enough
                const distance = Math.hypot(star.physics.x - homeX, star.physics.y - homeY);
                const speed = Math.hypot(star.physics.vx, star.physics.vy);

                if (distance < precision && speed < precision) {
                    star.physics.isAnimating = false;
                    star.physics.x = homeX;
                    star.physics.y = homeY;
                    star.physics.vx = 0;
                    star.physics.vy = 0;
                } else {
                    stillAnimating = true;
                }

                // Apply new position to the element
                star.style.left = `${star.physics.x}px`;
                star.style.top = `${star.physics.y}px`;
            });

            if (stillAnimating) {
                animationFrameId = requestAnimationFrame(animate);
            }
        }

        // Start the animation loop
        cancelAnimationFrame(animationFrameId);
        animationFrameId = requestAnimationFrame(animate);
    }

    // --- 3. INITIALIZATION AND RESIZE HANDLING ---
    layoutConstellation();
    window.addEventListener('resize', layoutConstellation);
});
</script>
<!-- ============================================================== -->
<!-- END DYNAMIC & PHYSICS-BASED LAYOUT SCRIPT -->
<!-- ============================================================== -->
{% endblock content %}