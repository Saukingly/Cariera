{% extends "partials/base.html" %}
{% load static %}
{% block title %}My Journeys{% endblock title %}

{% block extra_css %}
<style>
.sparkle-dot {
    position: absolute; top: 10px; left: 10px; width: 12px; height: 12px;
    background-color: #ff9800; border-radius: 50%;
    animation: pulse-orange 2s infinite; box-shadow: 0 0 0 0 rgba(255, 152, 0, 1);
}
@keyframes pulse-orange {
    0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.7); }
    70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(255, 152, 0, 0); }
    100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 152, 0, 0); }
}
.folder-drop-zone .list-group-item.sortable-ghost {
    background-color: #eef2ff; border: 2px dashed #4f46e5; color: transparent;
}
.folder-drop-zone .list-group-item.sortable-ghost * { visibility: hidden; }
#uncategorized-journeys .sortable-ghost { opacity: 0.4; background-color: #f3f3f3; }

/* Styles for folder dragging */
#folder-list .sortable-ghost {
    background-color: #f8fafc;
    border: 2px dashed #9ca3af;
    opacity: 0.7;
}
.drag-handle {
    cursor: grab;
}
.drag-handle:active {
    cursor: grabbing;
}
</style>
{% endblock extra_css %}

{% block content %}
<!-- Hidden Blueprints are unchanged -->
<div id="journey-template-container" style="display: none;">
    <div id="card-blueprint" class="col-xl-4 col-md-6" data-journey-id="__journey_id__">
        {% include 'journeys/journey_card.html' with journey=None %}
    </div>
    <div id="compact-item-blueprint" data-journey-id="__journey_id__">
        {% include 'journeys/journey_item_compact.html' with journey=None %}
    </div>
</div>

<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            <!-- page title -->
            <div class="row">
                <div class="col-12">
                    <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                        <h4 class="mb-sm-0">My Career Journeys</h4>
                        <div class="page-title-right">
                            <div class="d-flex gap-2 align-items-center">
                                <!-- Sort Dropdown -->
                                <div class="dropdown">
                                    <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="ri-sort-asc align-bottom me-1"></i>
                                        {% if current_sort == 'oldest' %}Oldest First{% else %}Newest First{% endif %}
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="?sort=newest{% if search_query %}&q={{ search_query }}{% endif %}">Newest First</a></li>
                                        <li><a class="dropdown-item" href="?sort=oldest{% if search_query %}&q={{ search_query }}{% endif %}">Oldest First</a></li>
                                    </ul>
                                </div>
                                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#createFolderModal"><i class="ri-folder-add-line align-bottom me-1"></i> Create Folder</button>
                                <a href="{% url 'apps:journeys.new' %}" class="btn btn-primary"><i class="ri-add-line align-bottom me-1"></i> Start a New Journey</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {% if search_query %}
            <div class="alert alert-info">Showing results for: <strong>"{{ search_query }}"</strong>. <a href="{% url 'apps:journeys.list' %}?sort={{ current_sort }}" class="alert-link">Clear search</a>.</div>
            {% endif %}

            <!-- RENDER FOLDERS -->
            <div id="folder-list">
                {% for folder in folders %}
                <div class="card" data-folder-id="{{ folder.id }}">
                    <div class="card-header d-flex align-items-center">
                        <div class="flex-shrink-0 me-2 drag-handle" title="Drag to reorder">
                            <i class="ri-drag-move-2-fill text-muted"></i>
                        </div>
                        <h5 class="card-title mb-0 flex-grow-1"><i class="ri-folder-2-line me-2"></i>{{ folder.name }}</h5>
                        <div class="flex-shrink-0">
                            <div class="dropdown"><a href="#" class="btn btn-ghost-secondary btn-sm icon-btn" data-bs-toggle="dropdown" aria-expanded="false"><i class="ri-more-2-fill"></i></a>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><button class="dropdown-item" type="button" data-bs-toggle="modal" data-bs-target="#renameFolderModal" data-folder-id="{{ folder.id }}" data-folder-name="{{ folder.name }}"><i class="ri-pencil-line align-bottom me-2 text-muted"></i> Rename</button></li>
                                    <li><form action="{% url 'apps:folders.delete' folder.id %}" method="post" onsubmit="return confirm('Delete this folder? Journeys will be moved to Uncategorized.');">{% csrf_token %}<button type="submit" class="dropdown-item text-danger"><i class="ri-delete-bin-line align-bottom me-2 text-danger"></i> Delete</button></form></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-2">
                        <div class="list-group list-group-flush folder-drop-zone" data-folder-id="{{ folder.id }}">
                            {% for journey in folder.journeys.all %}
                                {% include 'journeys/journey_item_compact.html' with journey=journey newly_auto_added_journey_id=newly_auto_added_journey_id %}
                            {% empty %}
                                <div class="text-center text-muted p-4">Drag journeys here to organize them.</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- RENDER UNFOLDERED JOURNEYS -->
            <div class="mt-4">
                <h5 class="mb-2 text-muted"><i class="ri-compass-3-line me-2"></i>Uncategorized</h5>
                <hr class="mt-0">
                <div class="row" id="uncategorized-journeys">
                    {% for journey in unfoldered_journeys %}
                    <div class="col-xl-4 col-md-6"
                         data-journey-id="{{ journey.id }}"
                         data-journey-title="{{ journey.title }}"
                         data-journey-updated-at="{{ journey.updated_at|timesince }} ago"
                         data-journey-last-message="{{ journey.messages.all.last.message|truncatechars:80 }}"
                         data-journey-chat-url="{% url 'apps:career_coach.chat' journey_id=journey.id %}"
                         data-journey-rename-url="{% url 'apps:journeys.rename' journey.id %}"
                         data-journey-delete-url="{% url 'apps:journeys.delete' journey.id %}">
                        {% include 'journeys/journey_card.html' with journey=journey %}
                    </div>
                    {% empty %}
                        {% if not folders and not unfoldered_journeys and not search_query %}
                            <div class="col-12 text-center py-5"><i class="ri-compass-3-line display-4 text-muted"></i><h5 class="mt-3">No Journeys Yet</h5><p class="text-muted">Start a journey to begin your exploration.</p></div>
                        {% elif search_query %}
                            <div class="col-12 text-center py-4"><i class="ri-search-line display-4 text-muted"></i><h5 class="mt-3">No Journeys Found</h5><p class="text-muted">No journeys matched your search.</p></div>
                        {% else %}
                             <div class="col-12 text-center text-muted py-4">All journeys are in folders. Drag them here to un-categorize.</div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% block footer %}{% include "partials/footer.html" %}{% endblock footer %}
</div>

{% include 'journeys/modals.html' %}
{% endblock content %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- FOLDER REORDERING LOGIC ---
    const folderList = document.getElementById('folder-list');
    if (folderList) {
        new Sortable(folderList, {
            handle: '.drag-handle', // Specify the drag handle
            animation: 150,
            onEnd: function (evt) {
                const folderElements = folderList.querySelectorAll('.card');
                const orderedFolderIds = Array.from(folderElements).map(el => el.dataset.folderId);

                fetch("{% url 'apps:folders.reorder' %}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ folder_ids: orderedFolderIds })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status !== 'success') { console.error('Folder reorder failed:', data.message); }
                })
                .catch(error => console.error('Network error:', error));
            }
        });
    }

    // --- JOURNEY DRAG-AND-DROP LOGIC (Unchanged) ---
    const uncategorizedContainer = document.getElementById('uncategorized-journeys');
    const folderContainers = document.querySelectorAll('.folder-drop-zone');
    const moveUrl = "{% url 'apps:journeys.move_drag_drop' %}";
    const cardBlueprint = document.getElementById('card-blueprint').innerHTML;
    const compactBlueprint = document.getElementById('compact-item-blueprint').innerHTML;

    function replacePlaceholders(html, data) {
        return html
            .replace(/__journey_id__/g, data.journeyId)
            .replace(/__journey_title__/g, data.journeyTitle)
            .replace(/__journey_updated_at__/g, data.journeyUpdatedAt)
            .replace(/__journey_last_message__/g, data.journeyLastMessage)
            .replace(/__journey_chat_url__/g, data.journeyChatUrl)
            .replace(/__journey_rename_url__/g, data.journeyRenameUrl)
            .replace(/__journey_delete_url__/g, data.journeyDeleteUrl);
    }

    const sortableOptions = {
        group: 'shared-journeys',
        animation: 150,
        onEnd: function (evt) {
            const itemEl = evt.item;
            const toContainer = evt.to;
            const toFolderId = toContainer.getAttribute('data-folder-id');
            const journeyData = { ...itemEl.dataset };

            if (toContainer.id === 'uncategorized-journeys') {
                const newCardHTML = replacePlaceholders(cardBlueprint, journeyData);
                const wrapperDiv = document.createElement('div');
                wrapperDiv.className = 'col-xl-4 col-md-6';
                wrapperDiv.dataset.journeyId = journeyData.journeyId;
                Object.keys(journeyData).forEach(key => { wrapperDiv.dataset[key] = journeyData[key]; });
                wrapperDiv.innerHTML = newCardHTML;
                itemEl.replaceWith(wrapperDiv);
            } else {
                const newCompactHTML = replacePlaceholders(compactBlueprint, journeyData);
                const wrapperDiv = document.createElement('div');
                wrapperDiv.dataset.journeyId = journeyData.journeyId;
                Object.keys(journeyData).forEach(key => { wrapperDiv.dataset[key] = journeyData[key]; });
                wrapperDiv.innerHTML = newCompactHTML;
                itemEl.replaceWith(wrapperDiv);
            }

            fetch(moveUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ journey_id: journeyData.journeyId, folder_id: toFolderId })
            }).then(response => response.json()).then(data => {
                if (data.status !== 'success') { console.error('Move failed:', data.message); }
            }).catch(error => console.error('Network error:', error));
        }
    };
    if (uncategorizedContainer) { new Sortable(uncategorizedContainer, sortableOptions); }
    folderContainers.forEach(folder => { new Sortable(folder, sortableOptions); });

    // Modal JavaScript logic remains the same...
});
</script>
{% endblock extra_js %}